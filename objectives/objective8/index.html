



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Kringlecon2 CTF Writeup">
      
      
      
        <meta name="author" content="Salaheldinaz">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>8 Bypassing the Frido Sleigh CAPTEHA - The Turtle Dove</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#e91e63">
      
    
    
      <script src="../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7CUbuntu+Mono&display=fallback">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../stylesheets/asciinema-player.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="pink" data-md-color-accent="grey">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#8-bypassing-the-frido-sleigh-capteha" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="The Turtle Dove" class="md-header-nav__button md-logo">
          
            <img src="../../images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              The Turtle Dove
            </span>
            <span class="md-header-nav__topic">
              
                8 Bypassing the Frido Sleigh CAPTEHA
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="The Turtle Dove" class="md-nav__button md-logo">
      
        <img src="../../images/logo.png" width="48" height="48">
      
    </a>
    The Turtle Dove
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Objectives
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Objectives
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../objective0/" title="0 Talk to Santa in the Quad" class="md-nav__link">
      0 Talk to Santa in the Quad
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective1/" title="1 Find the Turtle Doves" class="md-nav__link">
      1 Find the Turtle Doves
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective2/" title="2 Unredact Threatening Document" class="md-nav__link">
      2 Unredact Threatening Document
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective3/" title="3 Windows Log Analysis - Evaluate Attack Outcome" class="md-nav__link">
      3 Windows Log Analysis - Evaluate Attack Outcome
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective4/" title="4 Windows Log Analysis - Determine Attacker Technique" class="md-nav__link">
      4 Windows Log Analysis - Determine Attacker Technique
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective5/" title="5 Windows Log Analysis - Determine Compromised System" class="md-nav__link">
      5 Windows Log Analysis - Determine Compromised System
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective6/" title="6 Splnuk" class="md-nav__link">
      6 Splnuk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective7/" title="7 Get Access To The Steam Tunnels" class="md-nav__link">
      7 Get Access To The Steam Tunnels
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        8 Bypassing the Frido Sleigh CAPTEHA
      </label>
    
    <a href="./" title="8 Bypassing the Frido Sleigh CAPTEHA" class="md-nav__link md-nav__link--active">
      8 Bypassing the Frido Sleigh CAPTEHA
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#info-hints" class="md-nav__link">
    üìú Info &amp; Hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    ‚ö°Ô∏è Solution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#training-the-module" class="md-nav__link">
    Training the Module :
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#predicting-images-from-capteha" class="md-nav__link">
    Predicting Images from CAPTEHA  :
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youve-learned" class="md-nav__link">
    üéì What you've learned
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective9/" title="9 Retrieve Scraps of Paper from Server" class="md-nav__link">
      9 Retrieve Scraps of Paper from Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective10/" title="10 Recover Cleartext Document" class="md-nav__link">
      10  Recover Cleartext Document
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective11/" title="11 Open the Sleigh Shop Door" class="md-nav__link">
      11  Open the Sleigh Shop Door
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../objective12/" title="12 Filter Out Poisoned Sources of Weather Data" class="md-nav__link">
      12  Filter Out Poisoned Sources of Weather Data
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Helping the elves
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Helping the elves
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge1/" title="Escape Ed" class="md-nav__link">
      Escape Ed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge2/" title="Linux Path" class="md-nav__link">
      Linux Path
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge3/" title="Xmas laser cheers" class="md-nav__link">
      Xmas laser cheers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge4/" title="Splunk - The training questions" class="md-nav__link">
      Splunk - The training questions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge5/" title="Mongo Pilfer" class="md-nav__link">
      Mongo Pilfer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge6/" title="Nyanshell" class="md-nav__link">
      Nyanshell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge7/" title="Frosty Keypad" class="md-nav__link">
      Frosty Keypad
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge8/" title="Holiday Hack trail" class="md-nav__link">
      Holiday Hack trail
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge9/" title="Key Bitting" class="md-nav__link">
      Key Bitting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge10/" title="Graylog" class="md-nav__link">
      Graylog
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge11/" title="Smart Braces" class="md-nav__link">
      Smart Braces
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../helptheelves/challenge12/" title="Zeek JSON Analysis" class="md-nav__link">
      Zeek JSON Analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../terminals/" title="Terminals & Portals" class="md-nav__link">
      Terminals & Portals
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#info-hints" class="md-nav__link">
    üìú Info &amp; Hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    ‚ö°Ô∏è Solution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#training-the-module" class="md-nav__link">
    Training the Module :
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#predicting-images-from-capteha" class="md-nav__link">
    Predicting Images from CAPTEHA  :
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youve-learned" class="md-nav__link">
    üéì What you've learned
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="8-bypassing-the-frido-sleigh-capteha">8. <strong>Bypassing the Frido Sleigh CAPTEHA</strong><a class="headerlink" href="#8-bypassing-the-frido-sleigh-capteha" title="Permanent link">&para;</a></h1>
<blockquote>
<p>Difficulty: üéÑüéÑüéÑüéÑ</p>
</blockquote>
<p><img alt="obj8-1" src="../images/obj8/1.png" /></p>
<h2 id="info-hints">üìú Info &amp; Hints<a class="headerlink" href="#info-hints" title="Permanent link">&para;</a></h2>
<div class="admonition info">
<p class="admonition-title">Bypassing the Frido Sleigh CAPTEHA</p>
<p>Help Krampus beat <a href="https://fridosleigh.com/">the Frido Sleigh contest.</a></p>
<p>For hints on achieving this objective, please talk with Alabaster Snowball in the Speaker Unpreparedness Room.</p>
</div>
<div class="admonition quote">
<p class="admonition-title">üßùüèª‚Äç‚ôÇÔ∏è Krampus Hollyfeld</p>
<p>But, before I can tell you more, I need to know that I can trust you.</p>
<p>Tell you what ‚Äì if you can help me beat the <a href="https://fridosleigh.com/">Frido Sleigh</a> contest (Objective 8), then I'll know I can trust you.
The contest is here on my screen and at <a href="https://fridosleigh.com/">fridosleigh.com</a>.</p>
<p>No purchase necessary, enter as often as you want, so I am!<br>
They set up the rules, and lately, I have come to realize that I have certain materialistic, cookie needs.<br>
Unfortunately, it's restricted to elves only, and I can't bypass the CAPTEHA.</p>
<p>(That's Completely Automated Public Turing test to tell Elves and Humans Apart.)</p>
<p>I've already cataloged <a href="https://downloads.elfu.org/capteha_images.tar.gz">12,000 images</a> and decoded the <a href="https://downloads.elfu.org/capteha_api.py">API interface</a>.<br>
Can you help me bypass the CAPTEHA and submit lots of entries?</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Machine Learning</p>
<p><a href="https://youtu.be/jmVPLwjm_zs">Machine Learning Use Cases for Cyber Security</a></p>
</div>
<details class="info"><summary>Frido Sleigh Continuous Cookie Contest website</summary><p><img alt="obj8-13" src="../images/obj8/13.png" /></p>
</details>
<div class="admonition info">
<p class="admonition-title">Beat The Frido Sleigh contest</p>
</div>
<hr />
<h2 id="solution">‚ö°Ô∏è Solution<a class="headerlink" href="#solution" title="Permanent link">&para;</a></h2>
<p>Download:</p>
<ul>
<li>
<p><a href="https://downloads.elfu.org/capteha_images.tar.gz">12,000 images</a>.</p>
</li>
<li>
<p><a href="https://downloads.elfu.org/capteha_api.py">API interface script</a>.</p>
</li>
<li>
<p><code>predict_images_using_trained_model.py</code> and <code>retrain.py</code> from <a href="https://github.com/chrisjd20/img_rec_tf_ml_demo">Chris Davis github repository</a>.</p>
</li>
</ul>
<p>And make sure you have python installed then install the following python packages:</p>
<ul>
<li>
<p>tensorflow==1.15</p>
</li>
<li>
<p>tensorflow_hub</p>
</li>
</ul>
<p>Installation (Tested on Ubuntu 18.04 - 8GB Memory - 4 core cpu VM):
<div class="codehilite"><pre><span></span>sudo apt install python3 python3-pip -y
sudo python3 -m pip install --upgrade pip
sudo python3 -m pip install --upgrade setuptools
sudo python3 -m pip install --upgrade <span class="nv">tensorflow</span><span class="o">==</span><span class="m">1</span>.15
sudo python3 -m pip install tensorflow_hub
</pre></div></p>
<hr />
<h3 id="training-the-module">Training the Module :<a class="headerlink" href="#training-the-module" title="Permanent link">&para;</a></h3>
<p>We need to train our module then run it live to solve the CAPTEHA.</p>
<ol>
<li>
<p>Unzip downloaded images to a folder called <code>training_images</code> inside your code folder
    <img alt="obj8-2" src="../images/obj8/2.png" /></p>
<p>And the <code>training_images</code> folder will look like this:
<img alt="obj8-3" src="../images/obj8/3.png" /></p>
</li>
<li>
<p>Training our TensowFlow ML Model Based on Images in ./training_images/ Folder:</p>
<p>Make sure you are in your code directory and run:
<div class="codehilite"><pre><span></span>python3 retrain.py --image_dir ./training_images/
</pre></div>
<asciinema-player src="/terminals/ml1.cast" poster="npt:0:10" speed="2" theme="solarized-dark"></asciinema-player></p>
<p>This will create two files we will be using at:</p>
<ul>
<li>
<p><code>/tmp/retrain_tmp/output_graph.pb</code> - Trained Machine Learning Model</p>
</li>
<li>
<p><code>/tmp/retrain_tmp/output_labels.txt</code> - Labels for Images</p>
</li>
</ul>
</li>
</ol>
<hr />
<h3 id="predicting-images-from-capteha">Predicting Images from CAPTEHA  :<a class="headerlink" href="#predicting-images-from-capteha" title="Permanent link">&para;</a></h3>
<p>We need to get images into our module then do prediction based on our trained Model.</p>
<ol>
<li>
<p>Let's begin by understanding how the <code>CAPTEHA</code> api works by looking at <code>Network tab</code> in browser developer tools while you are using the website:</p>
<ol>
<li>
<p>First when you click on button the browser send <code>POST</code> request to get the images from the api at <code>https://fridosleigh.com/api/capteha/request</code>.</p>
<p><img alt="obj8-4" src="../images/obj8/4.png" /></p>
</li>
<li>
<p>The api response with images in a json object containing <code>uuid</code> for each image and the image itself encoded with base64, also the image types the CAPTEHA Challenge is looking for.</p>
<p><img alt="obj8-5" src="../images/obj8/5.png" /></p>
<p><img alt="obj8-6" src="../images/obj8/6.png" /></p>
<p><img alt="obj8-7" src="../images/obj8/7.png" /></p>
</li>
<li>
<p>Then after selecting the images and click <code>submit</code> your browser send <code>POST</code> request to the api at <code>https://fridosleigh.com/api/capteha/submit</code> with the answers in form of <code>uuid</code> list of all selected Images</p>
<p><img alt="obj8-8" src="../images/obj8/8.png" /></p>
<p><img alt="obj8-9" src="../images/obj8/9.png" />    </p>
</li>
<li>
<p>and the api response with the status/error message based on the answer: Is it correct? False? too few ?too many? ...</p>
<p><img alt="obj8-10" src="../images/obj8/10.png" />          </p>
</li>
</ol>
</li>
<li>
<p>Open <code>capteha_api.py</code> in your code editor:</p>
<details class="note"><summary>Original <code>capteha_api.py</code></summary><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Fridosleigh.com CAPTEHA API - Made by Krampus Hollyfeld</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">yourREALemailAddress</span> <span class="o">=</span> <span class="s2">&quot;YourRealEmail@SomeRealEmailDomain.RealTLD&quot;</span>

    <span class="c1"># Creating a session to handle cookies</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://fridosleigh.com/&quot;</span>

    <span class="n">json_resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/capteha/request&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">b64_images</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>                    <span class="c1"># A list of dictionaries eaching containing the keys &#39;base64&#39; and &#39;uuid&#39;</span>
    <span class="n">challenge_image_type</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>     <span class="c1"># The Image types the CAPTEHA Challenge is looking for.</span>
    <span class="n">challenge_image_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; and &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="c1"># cleaning and formatting</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    MISSING IMAGE PROCESSING AND ML IMAGE PREDICTION CODE GOES HERE</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># This should be JUST a csv list image uuids ML predicted to match the challenge_image_type .</span>
    <span class="n">final_answer</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="p">[</span> <span class="n">img</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">b64_images</span> <span class="p">]</span> <span class="p">)</span>

    <span class="n">json_resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/capteha/submit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;answer&#39;</span><span class="p">:</span><span class="n">final_answer</span><span class="p">})</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]:</span>
        <span class="c1"># If it fails just run again. ML might get one wrong occasionally</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FAILED MACHINE LEARNING GUESS&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">Our ML Guess:</span><span class="se">\n</span><span class="s1">--------------------</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_answer</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">Server Response:</span><span class="se">\n</span><span class="s1">--------------------</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CAPTEHA Solved!&#39;</span><span class="p">)</span>
    <span class="c1"># If we get to here, we are successful and can submit a bunch of entries till we win</span>
    <span class="n">userinfo</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Krampus Hollyfeld&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span><span class="n">yourREALemailAddress</span><span class="p">,</span>
        <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">180</span><span class="p">,</span>
        <span class="s1">&#39;about&#39;</span><span class="p">:</span><span class="s2">&quot;Cause they&#39;re so flippin yummy!&quot;</span><span class="p">,</span>
        <span class="s1">&#39;favorites&#39;</span><span class="p">:</span><span class="s1">&#39;thickmints&#39;</span>
    <span class="p">}</span>
    <span class="c1"># If we win the once-per minute drawing, it will tell us we were emailed.</span>
    <span class="c1"># Should be no more than 200 times before we win. If more, somethings wrong.</span>
    <span class="n">entry_response</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">yourREALemailAddress</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry_response</span> <span class="ow">and</span> <span class="n">entry_count</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submitting lots of entries until we win the contest! Entry #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_count</span><span class="p">))</span>
        <span class="n">entry_response</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/entry&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">userinfo</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="n">entry_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">entry_response</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

</details>
<p>As see we need to add our image processing an machine learning prediction code in  <code>capteha_api.py</code> :</p>
<div class="codehilite"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">MISSING IMAGE PROCESSING AND ML IMAGE PREDICTION CODE GOES HERE</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>

<p>Also make sure it's return return the final answer as list of <code>uuids</code> to send it back to the server</p>
<div class="codehilite"><pre><span></span>final_answer = &#39;,&#39;.join( [ img[&#39;uuid&#39;] for img in b64_images ] )
</pre></div>

</li>
<li>
<p>Open <code>predict_images_using_trained_model.py</code> in your code editor:</p>
<details class="note"><summary>Original <code>predict_images_using_trained_model.py</code></summary><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/python3</span>
<span class="c1"># Image Recognition Using Tensorflow Exmaple.</span>
<span class="c1"># Code based on example at:</span>
<span class="c1"># https://raw.githubusercontent.com/tensorflow/tensorflow/master/tensorflow/examples/label_image/label_image.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># sudo apt install python3-pip</span>
<span class="c1"># sudo python3 -m pip install --upgrade pip</span>
<span class="c1"># sudo python3 -m pip install --upgrade setuptools</span>
<span class="c1"># sudo python3 -m pip install --upgrade tensorflow==1.15</span>

<span class="k">def</span> <span class="nf">load_labels</span><span class="p">(</span><span class="n">label_file</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">proto_as_ascii_lines</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">label_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">proto_as_ascii_lines</span><span class="p">:</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">label</span>

<span class="k">def</span> <span class="nf">predict_image</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">image_bytes</span><span class="p">,</span> <span class="n">img_full_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">input_operation</span><span class="p">,</span> <span class="n">output_operation</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">read_tensor_from_image_bytes</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_operation</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span>
        <span class="n">input_operation</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">image</span>
    <span class="p">})</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="mi">5</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;img_full_path&#39;</span><span class="p">:</span><span class="n">img_full_path</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">[</span><span class="n">prediction</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span><span class="n">results</span><span class="p">[</span><span class="n">prediction</span><span class="p">]}</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">load_graph</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">graph_def</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GraphDef</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">graph_def</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">import_graph_def</span><span class="p">(</span><span class="n">graph_def</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graph</span>

<span class="k">def</span> <span class="nf">read_tensor_from_image_bytes</span><span class="p">(</span><span class="n">imagebytes</span><span class="p">,</span> <span class="n">input_height</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">input_width</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">input_mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">input_std</span><span class="o">=</span><span class="mi">255</span><span class="p">):</span>
    <span class="n">image_reader</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_png</span><span class="p">(</span> <span class="n">imagebytes</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;png_reader&quot;</span><span class="p">)</span>
    <span class="n">float_caster</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image_reader</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">dims_expander</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">float_caster</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">resized</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_bilinear</span><span class="p">(</span><span class="n">dims_expander</span><span class="p">,</span> <span class="p">[</span><span class="n">input_height</span><span class="p">,</span> <span class="n">input_width</span><span class="p">])</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">resized</span><span class="p">,</span> <span class="p">[</span><span class="n">input_mean</span><span class="p">]),</span> <span class="p">[</span><span class="n">input_std</span><span class="p">])</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Loading the Trained Machine Learning Model created from running retrain.py on the training_images directory</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">load_graph</span><span class="p">(</span><span class="s1">&#39;/tmp/retrain_tmp/output_graph.pb&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">load_labels</span><span class="p">(</span><span class="s2">&quot;/tmp/retrain_tmp/output_labels.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Load up our session</span>
    <span class="n">input_operation</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s2">&quot;import/Placeholder&quot;</span><span class="p">)</span>
    <span class="n">output_operation</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s2">&quot;import/final_result&quot;</span><span class="p">)</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span>

    <span class="c1"># Can use queues and threading to spead up the processing</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">unknown_images_dir</span> <span class="o">=</span> <span class="s1">&#39;unknown_images&#39;</span>
    <span class="n">unknown_images</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">unknown_images_dir</span><span class="p">)</span>

    <span class="c1">#Going to interate over each of our images.</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">unknown_images</span><span class="p">:</span>
        <span class="n">img_full_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unknown_images_dir</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing Image </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img_full_path</span><span class="p">))</span>
        <span class="c1"># We don&#39;t want to process too many images at once. 10 threads max</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>

        <span class="c1">#predict_image function is expecting png image bytes so we read image as &#39;rb&#39; to get a bytes object</span>
        <span class="n">image_bytes</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">img_full_path</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">predict_image</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">image_bytes</span><span class="p">,</span> <span class="n">img_full_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">input_operation</span><span class="p">,</span> <span class="n">output_operation</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting For Threads to Finish...&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_images</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c1">#getting a list of all threads returned results</span>
    <span class="n">prediction_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">())]</span>

    <span class="c1">#do something with our results... Like print them to the screen.</span>
    <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">prediction_results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TensorFlow Predicted </span><span class="si">{img_full_path}</span><span class="s1"> is a </span><span class="si">{prediction}</span><span class="s1"> with </span><span class="si">{percent:.2%}</span><span class="s1"> Accuracy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">prediction</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

</details>
<p>In here the predict images module is getting images from the folder <code>unknown_images</code> then process each one</p>
<div class="codehilite"><pre><span></span><span class="n">unknown_images_dir</span> <span class="o">=</span> <span class="s1">&#39;unknown_images&#39;</span>
<span class="n">unknown_images</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">unknown_images_dir</span><span class="p">)</span>
</pre></div>

<p>We need to link between the images from the api  and our input into predication module</p>
</li>
<li>
<p>Let's start by editing <code>capteha_api.py</code>:</p>
<p>Replace <code>YourRealEmail@SomeRealEmailDomain.RealTLD</code> with your email to receive the wining code
<div class="codehilite"><pre><span></span><span class="n">yourREALemailAddress</span> <span class="o">=</span> <span class="s2">&quot;YourRealEmail@SomeRealEmailDomain.RealTLD&quot;</span>
</pre></div></p>
<p>Import our predication module by adding this at the top of our script:
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">predict_images_using_trained_model</span>
</pre></div></p>
<p>Replace <code>final_answer</code> line with new one that gets the result from <code>main</code> function in <code>predict_images_using_trained_model</code> after providing <code>b64_images</code>, <code>challenge_image_types</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">final_answer</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predict_images_using_trained_model</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">b64_images</span><span class="p">,</span> <span class="n">challenge_image_types</span><span class="p">))</span>
</pre></div>

<p>So our final code will be:</p>
<details class="note"><summary>Modified <code>capteha_api.py</code></summary><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># Fridosleigh.com CAPTEHA API - Made by Krampus Hollyfeld</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="hll"><span class="kn">import</span> <span class="nn">predict_images_using_trained_model</span>
</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="hll">    <span class="n">yourREALemailAddress</span> <span class="o">=</span> <span class="s2">&quot;email@email.com&quot;</span>
</span>
    <span class="c1"># Creating a session to handle cookies</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://fridosleigh.com/&quot;</span>

    <span class="n">json_resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/capteha/request&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">b64_images</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span>                    <span class="c1"># A list of dictionaries eaching containing the keys &#39;base64&#39; and &#39;uuid&#39;</span>
    <span class="n">challenge_image_type</span> <span class="o">=</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;select_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>     <span class="c1"># The Image types the CAPTEHA Challenge is looking for.</span>
    <span class="n">challenge_image_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">challenge_image_type</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; and &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="c1"># cleaning and formatting</span>

    <span class="c1"># This should be JUST a csv list image uuids ML predicted to match the challenge_image_type .</span>
<span class="hll">    <span class="n">final_answer</span> <span class="o">=</span> <span class="n">predict_images_using_trained_model</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">b64_images</span><span class="p">,</span> <span class="n">challenge_image_types</span><span class="p">)</span>
</span>
    <span class="n">json_resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/capteha/submit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;answer&#39;</span><span class="p">:</span><span class="n">final_answer</span><span class="p">})</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]:</span>
        <span class="c1"># If it fails just run again. ML might get one wrong occasionally</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;FAILED MACHINE LEARNING GUESS&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">Our ML Guess:</span><span class="se">\n</span><span class="s1">--------------------</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_answer</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--------------------</span><span class="se">\n</span><span class="s1">Server Response:</span><span class="se">\n</span><span class="s1">--------------------</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">json_resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CAPTEHA Solved!&#39;</span><span class="p">)</span>
    <span class="c1"># If we get to here, we are successful and can submit a bunch of entries till we win</span>
    <span class="n">userinfo</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Krampus Hollyfeld&#39;</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span><span class="n">yourREALemailAddress</span><span class="p">,</span>
        <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">180</span><span class="p">,</span>
        <span class="s1">&#39;about&#39;</span><span class="p">:</span><span class="s2">&quot;Cause they&#39;re so flippin yummy!&quot;</span><span class="p">,</span>
        <span class="s1">&#39;favorites&#39;</span><span class="p">:</span><span class="s1">&#39;thickmints&#39;</span>
    <span class="p">}</span>
    <span class="c1"># If we win the once-per minute drawing, it will tell us we were emailed.</span>
    <span class="c1"># Should be no more than 200 times before we win. If more, somethings wrong.</span>
    <span class="n">entry_response</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">entry_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">yourREALemailAddress</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry_response</span> <span class="ow">and</span> <span class="n">entry_count</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Submitting lots of entries until we win the contest! Entry #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_count</span><span class="p">))</span>
        <span class="n">entry_response</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">api/entry&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">userinfo</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="n">entry_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">entry_response</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

</details>
</li>
<li>
<p>Editing <code>predict_images_using_trained_model.py</code>:</p>
<p>First we will need to import <code>base64</code> package to decode the images
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">base64</span>
</pre></div></p>
<p>then we change our <code>main</code> function accept two variables <code>b64_images</code>, <code>challenge_image_types</code>:
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">unknown_images</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
</pre></div></p>
<p>remove the following lines because we will get our images as input into the function:
<div class="codehilite"><pre><span></span><span class="n">unknown_images_dir</span> <span class="o">=</span> <span class="s1">&#39;unknown_images&#39;</span>
<span class="n">unknown_images</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">unknown_images_dir</span><span class="p">)</span>
</pre></div></p>
<p>Change the <code>img_full_path</code> to <code>uuid</code> :
<div class="codehilite"><pre><span></span><span class="n">img_full_path</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span>
</pre></div></p>
<p>replace <code>image_bytes</code> line with our decoded base64 image
<div class="codehilite"><pre><span></span>image_bytes = base64.b64decode(image[&#39;base64&#39;])
</pre></div></p>
<p>Create an empty list for <code>uuids</code> matching the challenge types <br />
<div class="codehilite"><pre><span></span><span class="n">uuids_list</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div></p>
<p>Check predict image type if it's in the capteha_api challenge types
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
    <span class="n">uuids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;img_full_path&#39;</span><span class="p">])</span>
</pre></div></p>
<p>finally return the uuids list
<div class="codehilite"><pre><span></span><span class="k">return</span> <span class="n">uuids_list</span>    
</pre></div></p>
<p>So our final code will be:</p>
<details class="note"><summary>Modified <code>predict_images_using_trained_model.py</code></summary><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/python3</span>
<span class="c1"># Image Recognition Using Tensorflow Exmaple.</span>
<span class="c1"># Code based on example at:</span>
<span class="c1"># https://raw.githubusercontent.com/tensorflow/tensorflow/master/tensorflow/examples/label_image/label_image.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">base64</span>


<span class="k">def</span> <span class="nf">load_labels</span><span class="p">(</span><span class="n">label_file</span><span class="p">):</span>
    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">proto_as_ascii_lines</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">label_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">proto_as_ascii_lines</span><span class="p">:</span>
        <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">label</span>

<span class="k">def</span> <span class="nf">predict_image</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">image_bytes</span><span class="p">,</span> <span class="n">img_full_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">input_operation</span><span class="p">,</span> <span class="n">output_operation</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">read_tensor_from_image_bytes</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">output_operation</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span>
        <span class="n">input_operation</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">image</span>
    <span class="p">})</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="mi">5</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;img_full_path&#39;</span><span class="p">:</span><span class="n">img_full_path</span><span class="p">,</span> <span class="s1">&#39;prediction&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">[</span><span class="n">prediction</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="s1">&#39;percent&#39;</span><span class="p">:</span><span class="n">results</span><span class="p">[</span><span class="n">prediction</span><span class="p">]}</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">load_graph</span><span class="p">(</span><span class="n">model_file</span><span class="p">):</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    <span class="n">graph_def</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">GraphDef</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">graph_def</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">graph</span><span class="o">.</span><span class="n">as_default</span><span class="p">():</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">import_graph_def</span><span class="p">(</span><span class="n">graph_def</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">graph</span>

<span class="k">def</span> <span class="nf">read_tensor_from_image_bytes</span><span class="p">(</span><span class="n">imagebytes</span><span class="p">,</span> <span class="n">input_height</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">input_width</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">input_mean</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">input_std</span><span class="o">=</span><span class="mi">255</span><span class="p">):</span>
    <span class="n">image_reader</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_png</span><span class="p">(</span> <span class="n">imagebytes</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;png_reader&quot;</span><span class="p">)</span>
    <span class="n">float_caster</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image_reader</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">dims_expander</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">float_caster</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">resized</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize_bilinear</span><span class="p">(</span><span class="n">dims_expander</span><span class="p">,</span> <span class="p">[</span><span class="n">input_height</span><span class="p">,</span> <span class="n">input_width</span><span class="p">])</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">resized</span><span class="p">,</span> <span class="p">[</span><span class="n">input_mean</span><span class="p">]),</span> <span class="p">[</span><span class="n">input_std</span><span class="p">])</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">unknown_images</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
    <span class="c1"># Loading the Trained Machine Learning Model created from running retrain.py on the training_images directory</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">load_graph</span><span class="p">(</span><span class="s1">&#39;/tmp/retrain_tmp/output_graph.pb&#39;</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">load_labels</span><span class="p">(</span><span class="s2">&quot;/tmp/retrain_tmp/output_labels.txt&quot;</span><span class="p">)</span>

    <span class="c1"># Load up our session</span>
    <span class="n">input_operation</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s2">&quot;import/Placeholder&quot;</span><span class="p">)</span>
    <span class="n">output_operation</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s2">&quot;import/final_result&quot;</span><span class="p">)</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">graph</span><span class="o">=</span><span class="n">graph</span><span class="p">)</span>

    <span class="c1"># Can use queues and threading to spead up the processing</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="c1">#Going to interate over each of our images.</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">unknown_images</span><span class="p">:</span>
        <span class="n">img_full_path</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing Image </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">img_full_path</span><span class="p">))</span>
        <span class="c1"># We don&#39;t want to process too many images at once. 10 threads max</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>

        <span class="c1">#predict_image function is expecting png image bytes so we read image as &#39;rb&#39; to get a bytes object</span>
        <span class="n">image_bytes</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;base64&#39;</span><span class="p">])</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">predict_image</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">image_bytes</span><span class="p">,</span> <span class="n">img_full_path</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">input_operation</span><span class="p">,</span> <span class="n">output_operation</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting For Threads to Finish...&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_images</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c1">#getting a list of all threads returned results</span>
    <span class="n">prediction_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">qsize</span><span class="p">())]</span>

    <span class="c1">#create list of our uuids matching the types</span>
    <span class="n">uuids_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">prediction_results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TensorFlow Predicted </span><span class="si">{img_full_path}</span><span class="s1"> is a </span><span class="si">{prediction}</span><span class="s1"> with </span><span class="si">{percent:.2%}</span><span class="s1"> Accuracy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">prediction</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">uuids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prediction</span><span class="p">[</span><span class="s1">&#39;img_full_path&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">uuids_list</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

</details>
</li>
<li>
<p>Let's run and win!</p>
<div class="codehilite"><pre><span></span>python3 capteha_api.py
</pre></div>

<p><asciinema-player src="/terminals/ml2.cast" poster="npt:0:25" speed="2" theme="solarized-dark"></asciinema-player></p>
<p>And you get the winning message:</p>
<div class="admonition success">
<p class="admonition-title">Congratulations and Happy Holidays!</p>
<p>Entries for email address <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#89;&#111;&#117;&#114;&#82;&#101;&#97;&#108;&#69;&#109;&#97;&#105;&#108;&#64;&#83;&#111;&#109;&#101;&#82;&#101;&#97;&#108;&#69;&#109;&#97;&#105;&#108;&#68;&#111;&#109;&#97;&#105;&#110;&#46;&#82;&#101;&#97;&#108;&#84;&#76;&#68;">&#89;&#111;&#117;&#114;&#82;&#101;&#97;&#108;&#69;&#109;&#97;&#105;&#108;&#64;&#83;&#111;&#109;&#101;&#82;&#101;&#97;&#108;&#69;&#109;&#97;&#105;&#108;&#68;&#111;&#109;&#97;&#105;&#110;&#46;&#82;&#101;&#97;&#108;&#84;&#76;&#68;</a> no longer accepted as our systems show your email was already randomly selected as a winner!</p>
<p>Go check your email to get your winning code. Please allow up to 3-5 minutes for the email to arrive in your inbox or check your spam filter settings.</p>
<p>Congratulations and Happy Holidays!</p>
</div>
<p>Check you email for an email from <code>contest@fridosleigh.com</code> to get the wining code:</p>
<p><img alt="obj8-11" src="../images/obj8/11.png" />    </p>
<div class="admonition success">
<p class="admonition-title">Winning code</p>
<p>To receive your reward, simply attend KringleCon at Elf University and submit the following code in your badge:
<code>8Ia8LiZEwvyZr2WO</code></p>
</div>
</li>
</ol>
<div class="admonition done">
<p class="admonition-title">Congratulations! You have completed the Bypassing the Frido Sleigh CAPTEHA challenge! üéâ</p>
</div>
<div class="admonition quote">
<p class="admonition-title">üßùüèª‚Äç‚ôÇÔ∏è Krampus Hollyfeld</p>
<p>You did it! Thank you so much. I can trust you!<br>
To help you, I have flashed the firmware in your badge to unlock a useful new feature: magical teleportation through the steam tunnels.</p>
<p>As for those scraps of paper, I scanned those and put the images on my server.<br>
I then threw the paper away.<br>
Unfortunately, I managed to lock out my account on the server.</p>
<p>Hey! You‚Äôve got some great skills. Would you please hack into my system and retrieve the scans?<br>
I give you permission to hack into it, solving Objective 9 in your badge.<br>
And, as long as you're traveling around, be sure to solve any other challenges you happen across.</p>
</div>
<p>Now we can use steam tunnels fo teleportation!</p>
<p><img alt="obj8-12" src="../images/obj8/12.png" />    </p>
<hr />
<h2 id="what-youve-learned">üéì What you've learned<a class="headerlink" href="#what-youve-learned" title="Permanent link">&para;</a></h2>
<ul>
<li>Image Recognition Using TensorFlow Machine Learning.</li>
<li>Interacting with api and understand dataflow to be able to manipulate the result.  </li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../objective7/" title="7 Get Access To The Steam Tunnels" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                7 Get Access To The Steam Tunnels
              </span>
            </div>
          </a>
        
        
          <a href="../objective9/" title="9 Retrieve Scraps of Paper from Server" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                9 Retrieve Scraps of Paper from Server
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 Santa NP
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://twitter.com/salaheldinaz" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://salaheldin.online" class="md-footer-social__link fa fa-ra"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
        <script src="../../javascripts/asciinema-player.js"></script>
      
    
  </body>
</html>